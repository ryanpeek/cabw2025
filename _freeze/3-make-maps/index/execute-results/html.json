{
  "hash": "e9c2ba3e4d490228d518e40b055ed169",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Make Maps\nengine: knitr\nformat: live-html\nwebr:\n  render-df: gt-interactive\n  packages:\n    - dplyr\n    - ggplot2\n    - sf\n    - mapview\n    - ggspatial\n  cell-options:\n    editor-font-scale: 0.8\n    fig-width: 7\n    fig-height: 4.3\n    out-width: \"100%\"\neditor_options: \n  chunk_output_type: console\n---\n\n\n::: {.cell}\n\n:::\n\n\n\n## Load Libraries\n\nWe will use the following in this tutorial:\n\n```\nlibrary(dplyr)\nlibrary(sf)\nlibrary(mapview)\nlibrary(ggplot2)\nlibrary(ggspatial)\nlibrary(tigris)\n```\n\nLet's take the same data and learn how to explore/make a few simple maps. There are some excellent spatial resources in the R universe, so we are only going to show a few basics. For more, definitely check out these spatial/mapping resources:\n\n - [Geocomputation with R](https://r.geocompx.org/)\n - [Spatial Data Science](https://r-spatial.org/book/)\n - [Spatial Statistics with R](https://www.paulamoraga.com/book-spatial/index.html)\n - [Methods for comparing spatial patterns in raster data](https://jakubnowosad.com/posts/2024-10-13-spatcomp-bp1/)\n\n## Import the Data\n\nUse the same dataset we've been working with in previous lessons. If you are playing along at home, make sure to install/load libraries above.\n\n\n::: {.cell}\n```{webr}\n# Benthic Macroinvertebrate Data\ncsci_url <- \"https://raw.githubusercontent.com/ryanpeek/cabw2025/refs/heads/main/data/cscidat.csv\"\ncscidat <- read.csv(csci_url)\n\n# Algae Data\nasci_url <- \"https://raw.githubusercontent.com/ryanpeek/cabw2025/refs/heads/main/data/ascidat.csv\"\nascidat <- read.csv(asci_url)\n\n# Site Location Data\nlatlons <- read.csv(file =  \"https://raw.githubusercontent.com/ryanpeek/cabw2025/refs/heads/main/data/latlon.csv\")\nglimpse(latlons)\n\n```\n:::\n\n\n## Make Data Spatial\n\nNow we have data, which as a spatial component. That is, we can use the `latitude` and `longitude` columns to map our data. This could be done by simply plotting points with `x` and `y` as `latitude` and `longitude`, however, if we wanted to do spatial analysis, or utilize the myriad of spatial mapping options in R, we need these data to have a spatial format. For vector (points, lines, polygons) data, the most stable and easiest option is to use the `{sf}` package and create a **simple features** data frame. Let's do that after we talk about projections!\n\n### Projections/Transformations\n\nSpatial data is tricky, because different parts of the world work in different “datum” or “projections”. One way to describe how these projections work is to imagine draping a square tablecloth over a round ball (Earth). The tablecloth isn’t quite big enough to cover the whole globe, so near the edges of the tablecloth there’s stretching or wrinkling of your square. At the center of the tablecloth there’s very little stretching, and that's the most accurate spot from a spatial perspective. When working with spatial data, we want a projection that is going to give us the least amount of stretching for the location/region we’re working in. \n\nA few common projections used in California for state/federal work:\n\n - [NAD83 California Albers: EPSG 3310](https://epsg.io/3310)\n - [NAD83 California Teal Albers Equal Area: EPSG 102600](https://epsg.io/102600)\n - [WGS84 Lat Lon: EPSG 4326](https://epsg.io/4326)\n \n\n### Convert to [`{sf}`](https://r-spatial.github.io/sf/)\n\nTo leverage all the spatial power R provides, we will use the `{sf}` package, which provides a full suite of functionality for spatial analysis of **vector** data. We need to use `st_as_sf()` to convert our data frame to a simple feature (spatial) object. As part of that we need to specify the coordinate reference system (`crs=`) and `coords` columns.\n\nIf all goes well, we should end up with a new `geometry` column, which contains our projected spatial data in a single column. This applies to point, line, or polygon data, there will always be **one** `geometry` column with the spatial information. And it will *stick* with the data!\n\n![{sf} \"sticky\" geometry columns remain with the data! Art by Allison Horst](https://cdn.myportfolio.com/45214904-6a61-4e23-98d6-b140f8654a40/6025ee5a-bf25-4275-a211-16f4425089d2_rw_1920.png?h=8df287c0e9803a81d2406fdd7ff938da)\n\n\n::: {.cell}\n```{webr}\n# make sf\nxy_sf <- latlons |> # pass data along\n  # make spatial\n  st_as_sf(\n    coords=c(\"New_Long\", \"New_Lat\"), # coordinate columns\n    crs=4326, # the coordinate ref system\n    remove=FALSE) # keep the lat/lon columns in dataframe\n\n# look at the object\nhead(xy_sf)\n\n```\n:::\n\n\n\n::: {.callout-tip}\n## 📣 Raster Data\n\nWe simply don't have time to cover all the things, but if you work with raster data, the best recommended all-in-one package to use is [`{terra}`](https://rspatial.github.io/terra/).\n\n:::\n\n## Simple Map\n\nWe can start by using the `plot()` function. Here we are actually using a modified `plot()` function from the `{sf}` package, to handle the spatial data.\n\n\n::: {.cell autorun='false'}\n```{webr}\n#| autorun: false\n#| label: \"First Plot\"\nplot(xy_sf$geometry)\n\n# what happens if we just plot(xy_sf)? Try it!\n```\n:::\n\n\n## Interactive Maps\n\nAnother amazing tool to add to the repertoire is the `{mapview}` package. It's very easy to use, and is a great option for exploring your data. Make sure we have installed and loaded the package, and then give it a try.\n\n\n::: {.cell}\n```{webr}\nmapview(xy_sf)\n\n# hint, try with the argument zcol=\"NAME\"\n```\n:::\n\n\n## `ggplot` Maps\n\nWe've used `{ggplot2}` in the previous lessons, here we build it out a bit more and add a our spatial data. Great news, we can use `geom_sf()` to plot any `{sf}` data in our `ggplot`!\n\n\n\n::: {.cell}\n```{webr}\n\nnicemap<-\n  ggplot() + # set up the framework\n  # add the \"sf\" data\n  geom_sf(data=xy_sf, fill=\"orange\", pch=21, alpha=0.7, size=2)+\n  # modify our labels\n  labs(x=\"Longitude (WGS84)\", y=\"Latitude\", title=\"Map of Points\") + \n  theme_minimal() # check out the many themes in ggplot!\nnicemap\n```\n:::\n\n\n\n::: {.callout-tip}\n## 📣 Why no `aes()`?\n\n`geom_sf()` automatically detects and uses the `geometry` column in the `{sf}` class data frame. So we don't need to specify an `x` or `y`. *However*, we can certainly map different variables to other `aes()` options, like `aes(fill=NAME)` to map a unique color to each CA county name!\n\n:::\n\n# Fancy Maps\n\nThe following sections show some additional options you can add to your maps without too much hassle (*hopefully!*)\n\n## Getting Boundaries\n\nA great part of maps it having some easy boundaries or delineations that help locate your site or location. One great option is the [{`tigris`}](https://github.com/walkerke/tigris), which allows users to directly download and use TIGER/Line shapefiles from the US Census Bureau. This includes roads, counties, states and more. Let's download county boundaries for California and use them in our map.\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get counties in CA\nca_cnty <- tigris::counties(state=\"CA\", progress_bar=FALSE)\n\n# what projection are they in?\nsf::st_crs(ca_cnty)\n\n# what projection was our xy_sf data in?\n```\n:::\n\n\nNow we can plug this straight into our ggplot map from before. note, the order we add the layers into `ggplot` matters. Try changing them around to see what things look like!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnicemap_w_cnty <-\n  ggplot() + # set up the framework\n  # add our county outlines as the base\n  geom_sf(data = ca_cnty, color=\"gray20\", lwd=0.2) + \n  geom_sf(data=xy_sf, fill=\"orange\", pch=21, alpha=0.7, size=2)+\n  labs(x=\"Longitude (WGS84)\", y=\"Latitude\", title=\"Map of Points\", subtitle=\"Improved with Californa Counties now!\") + \n  theme_minimal() # check out the many themes in ggplot!\n\nnicemap_w_cnty\n```\n\n::: {.cell-output-display}\n![Fancy map with county boundaries.](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n## Adding North Arrow & Scale Bars\n\nA common bit of polish on a map to make it publication ready is to include a scale bar and north arrow or compass. The [`{ggspatial}`](https://paleolimbot.github.io/ggspatial/) package makes this easy in `ggplot`. Let's build on our fancy map.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnicemap_w_scales <-\n  ggplot() + \n  geom_sf(data = ca_cnty, color=\"gray20\", lwd=0.2) + \n  geom_sf(data=xy_sf, fill=\"orange\", pch=21, alpha=0.7, size=2)+\n  labs(x=\"Longitude (WGS84)\", y=\"Latitude\", title=\"Map of Points\", subtitle=\"Improved with scale and N arrow!\") + \n  theme_minimal() +\n  ggspatial::annotation_north_arrow(location = \"tr\") +\n  ggspatial::annotation_scale(location = \"bl\")\n\nnicemap_w_scales\n```\n\n::: {.cell-output-display}\n![Fancy map with scale bar and North arrow.](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n## `basemaps`\n\nFinally, one of the cool options to make your map really shine, is adding a basemap. This does require some extra work, but adding code here so you can see how it's done for a future map! Notice here we need to leverage a few packages we haven't used yet, including {basemaps}, {terra}, and {tidyterra}. I've found this approach is most stable across platforms, but does require a little extra work to get it \"map-ready\".\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(basemaps)\nlibrary(terra)\nlibrary(tidyterra)\n\n# set the default map type...there are many!\nset_defaults(map_service = \"esri\", map_type = \"world_hillshade\")\n# note we need to transform to this projection for ease of use\nca_base <- basemaps::basemap_terra(st_transform(ca_cnty, 3857))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLoading basemap 'world_hillshade' from map service 'esri'...\n```\n\n\n:::\n\n```{.r .cell-code}\n# now plot\nnice_basemap<-\n  ggplot() + \n  # add the base map first! we can change alpha here too\n  tidyterra::geom_spatraster_rgb(data=ca_base) + \n  # now county layer\n  geom_sf(data = ca_cnty, fill=\"transparent\", color=\"gray20\", lwd=0.2) + \n  # now points\n  geom_sf(data=xy_sf, fill=\"orange\", pch=21, alpha=0.7, size=2)+\n  labs(x=\"Longitude (WGS84)\", y=\"Latitude\", title=\"Map of Points\") + \n  theme_minimal()\n\nnice_basemap\n```\n\n::: {.cell-output-display}\n![Base map with scale bar and North arrow.](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nThat's a lot of options! Hope you give some a try and once you make one map, it's tons of fun to make more!\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}